<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXA Stat Pro Advisor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1a1a1a; margin: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        h1 { color: #2c3e50; margin-bottom: 8px; font-size: 2rem; }
        .author-link { font-size: 0.95rem; color: #0088cc; text-decoration: none; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; }

        .grid-layout { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; color: #6c757d; }
        input { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; }
        input:invalid { border: 2px solid #e74c3c; }

        button { grid-column: 1 / -1; padding: 14px; background: linear-gradient(135deg, #2e86c1, #21618c); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 600; margin-top: 10px; }

        .meta-dashboard { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; }
        .meta-item { display: flex; justify-content: space-between; border-bottom: 1px solid #3e4f5f; padding-bottom: 8px; }
        .meta-label { font-size: 0.8rem; color: #bdc3c7; }
        .meta-value { font-family: 'Courier New', monospace; font-weight: bold; color: #3498db; }

        #resultsBox { margin-top: 20px; padding: 25px; border-radius: 10px; border-left: 8px solid #2e86c1; display: none; }
        .advice-keep { border-color: #27ae60 !important; background: #f0fff4 !important; color: #1e4620; }
        .advice-reset { border-color: #e74c3c !important; background: #fff5f5 !important; color: #611a15; }

        .result-title { font-size: 1.6rem; font-weight: 800; display: block; margin-bottom: 12px; }
        .result-detail { line-height: 1.7; font-size: 1.05rem; }
        .outcome-stats { margin-top: 15px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1); }

        canvas { margin-top: 30px; width: 100% !important; height: auto !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>HEXA Stat Pro Advisor</h1>
        <a href="https://t.me/Hirafuu" class="author-link" target="_blank">Contact Author: @Hirafuu</a>
    </div>

    <div class="grid-layout">
        <div class="input-grid">
            <div class="input-group"><label>Main Stat Lv</label><input type="number" id="cMain" value="3" min="0" max="10"></div>
            <div class="input-group"><label>Sub Stat 1 Lv</label><input type="number" id="cSub1" value="5" min="0" max="10"></div>
            <div class="input-group"><label>Sub Stat 2 Lv</label><input type="number" id="cSub2" value="4" min="0" max="10"></div>
            <div class="input-group"><label>Main Goal (≥)</label><input type="number" id="tMain" value="7" min="0" max="10"></div>
            <div class="input-group"><label>Sub Goal (≥)</label><input type="number" id="tSub" value="0" min="0" max="10"></div>
            <div class="input-group"><label>Billion/Frag</label><input type="number" id="fragPrice" value="0.25" min="0"></div>
            <button onclick="runSimulation()">Calculate Optimal Strategy</button>
        </div>

        <div class="meta-dashboard">
            <h3 style="margin: 0; font-size: 1rem; text-align: center; color: #3498db;">Real-time Metrics</h3>
            <div class="meta-item"><span class="meta-label">Total Slots Used</span><span class="meta-value" id="metaClicks">--</span></div>
            <div class="meta-item"><span class="meta-label">Luck Delta</span><span class="meta-value" id="metaLuck">--</span></div>
            <div class="meta-item"><span class="meta-label">Success Scenarios</span><span class="meta-value" id="metaSuccess">--</span></div>
            <div class="meta-item"><span class="meta-label">Simulation Trials</span><span class="meta-value">100,000</span></div>
        </div>
    </div>

    <div id="resultsBox">
        <span id="adviceLabel" class="result-title"></span>
        <div id="statsDetails" class="result-detail"></div>
        <div id="outcomeDetails" class="result-detail outcome-stats"></div>
    </div>

    <canvas id="distributionChart"></canvas>
</div>

<script>
    let chartInstance = null;

    // Helper to clamp values between 0 and 10
    function clamp(val) {
        return Math.max(0, Math.min(10, val));
    }

    function get_main_rate(lvl) {
        if (lvl >= 10) return 0.0;
        const rates = {0: 0.35, 1: 0.35, 2: 0.20, 3: 0.20, 4: 0.20, 5: 0.20, 6: 0.15, 7: 0.10, 8: 0.05, 9: 0.05};
        return rates[lvl] || 0.0;
    }

    function get_cost(lvl) {
        if (lvl < 2) return 10;
        if (lvl < 6) return 20;
        if (lvl == 6) return 30;
        if (lvl == 7) return 40;
        return 50;
    }

    function simulate_remaining(m, s1, s2) {
        let cur_m = m, cur_s1 = s1, cur_s2 = s2, frags = 0, used = cur_m + cur_s1 + cur_s2;
        for (let i = 0; i < (20 - used); i++) {
            frags += get_cost(cur_m);
            let m_r = get_main_rate(cur_m), s1_r = cur_s1 < 10 ? 0.325 : 0.0, s2_r = cur_s2 < 10 ? 0.325 : 0.0;
            let total_w = m_r + s1_r + s2_r;
            if (total_w <= 0) break;
            let roll = Math.random() * total_w;
            if (roll < m_r) cur_m++; else if (roll < m_r + s1_r) cur_s1++; else cur_s2++;
        }
        return [cur_m, cur_s1, cur_s2, frags];
    }

    function runSimulation() {
        // Sanitize inputs
        const cM = clamp(parseInt(document.getElementById('cMain').value) || 0);
        const cS1 = clamp(parseInt(document.getElementById('cSub1').value) || 0);
        const cS2 = clamp(parseInt(document.getElementById('cSub2').value) || 0);
        const tM = clamp(parseInt(document.getElementById('tMain').value) || 0);
        const tS = clamp(parseInt(document.getElementById('tSub').value) || 0);
        const price = Math.max(0, parseFloat(document.getElementById('fragPrice').value) || 0);

        // Update UI to show clamped values
        document.getElementById('cMain').value = cM;
        document.getElementById('cSub1').value = cS1;
        document.getElementById('cSub2').value = cS2;
        document.getElementById('tMain').value = tM;
        document.getElementById('tSub').value = tS;

        const trials = 500000;
        let curRes = [], baseRes = [], curWins = 0, baseWins = 0;
        let sumCurFrags = 0, sumBaseFrags = 0, sumCurM = 0, sumCurS1 = 0, sumCurS2 = 0;

        for (let i = 0; i < trials; i++) {
            let r = simulate_remaining(cM, cS1, cS2); curRes.push(r);
            sumCurFrags += r[3];
            sumCurM += r[0]; sumCurS1 += r[1]; sumCurS2 += r[2];
            if ((tM > 0 && r[0] >= tM) || (tS > 0 && (r[1] >= tS || r[2] >= tS))) curWins++;

            let b = simulate_remaining(0, 0, 0); baseRes.push(b);
            sumBaseFrags += (b[3] + 10);
            if ((tM > 0 && b[0] >= tM) || (tS > 0 && (b[1] >= tS || b[2] >= tS))) baseWins++;
        }

        const pCur = curWins / trials, pBase = baseWins / trials;
        const avgCurFrags = sumCurFrags / trials;
        const avgBaseFrags = sumBaseFrags / trials;
        const expectedAttemptsBase = 1 / (pBase || 0.0001);
        const expTotalBaseFrags = avgBaseFrags * expectedAttemptsBase;
        const expTotalCurFrags = avgCurFrags + ((1 - pCur) / (pCur || 0.0001)) * expTotalBaseFrags;

        document.getElementById('metaClicks').innerText = cM + cS1 + cS2 + " / 20";
        const luckDelta = (pCur - pBase) * 100;
        document.getElementById('metaLuck').innerText = (luckDelta > 0 ? "+" : "") + luckDelta.toFixed(2) + "%";
        document.getElementById('metaLuck').style.color = luckDelta > -0.2 ? "#27ae60" : "#e74c3c";
        document.getElementById('metaSuccess').innerText = curWins.toLocaleString() + " hits";

        const box = document.getElementById('resultsBox');
        box.style.display = "block";
        const adviceLabel = document.getElementById('adviceLabel');

        if (pCur < (pBase - 0.002)) {
            adviceLabel.innerText = "RECOMMENDATION: RESTART CORE";
            box.className = "advice-reset";
        } else {
            adviceLabel.innerText = "RECOMMENDATION: KEEP ENHANCING";
            box.className = "advice-keep";
        }

        document.getElementById('statsDetails').innerHTML = `
            To complete this current core to LV20, you need to use <b>${avgCurFrags.toFixed(1)} fragments</b> (${(avgCurFrags * price).toFixed(2)}B mesos). 
            Doing so gives you a <b>${(pCur * 100).toFixed(2)}%</b> success rate. <br>
            To restart, you are expected to spend <b>${avgBaseFrags.toFixed(1)} fragments</b> per attempt from LV0 to LV20, 
            and you will have a <b>${(pBase * 100).toFixed(2)}%</b> baseline to reach your goal 
            (approx. <b>${expectedAttemptsBase.toFixed(1)} attempts</b> to succeed, costing <b>${expTotalBaseFrags.toFixed(0)} total fragments</b> | <b>${(expTotalBaseFrags * price).toFixed(2)}B mesos</b>).
        `;

        document.getElementById('outcomeDetails').innerHTML = `
            <b>Expected Final Stats:</b> Main Lv <b>${(sumCurM/trials).toFixed(2)}</b>, 
            Sub1 Lv <b>${(sumCurS1/trials).toFixed(2)}</b>, 
            Sub2 Lv <b>${(sumCurS2/trials).toFixed(2)}</b>
        `;

        updateChart(curRes, trials, tM);
    }

    function updateChart(data, trials, tM) {
        const ctx = document.getElementById('distributionChart').getContext('2d');
        const mainC = new Array(11).fill(0), s1C = new Array(11).fill(0), s2C = new Array(11).fill(0);
        data.forEach(r => { mainC[r[0]]++; s1C[r[1]]++; s2C[r[2]]++; });

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                datasets: [
                    { label: 'Main Stat', data: mainC.map(c => (c / trials) * 100), borderColor: '#2e86c1', backgroundColor: 'rgba(46, 134, 193, 0.1)', fill: true, tension: 0.4, borderWidth: 3.5 },
                    { label: 'Sub Stat 1', data: s1C.map(c => (c / trials) * 100), borderColor: '#d35400', tension: 0.4, borderWidth: 1.5, borderDash: [3, 3], pointRadius: 0 },
                    { label: 'Sub Stat 2', data: s2C.map(c => (c / trials) * 100), borderColor: '#27ae60', tension: 0.4, borderWidth: 1.5, borderDash: [3, 3], pointRadius: 0 }
                ]
            },
            options: {
                plugins: {
                    annotation: {
                        annotations: {
                            line1: { type: 'line', xMin: tM, xMax: tM, borderColor: 'rgba(46, 134, 193, 0.6)', borderWidth: 3, borderDash: [6, 6], label: { display: true, content: 'Target Level', backgroundColor: 'rgba(46, 134, 193, 0.8)', color: 'white' } }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Probability (%)' } },
                    x: { title: { display: true, text: 'Final Level' } }
                }
            }
        });
    }
</script>
</body>
</html>
